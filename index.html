<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Joyful Journeys (WAPS Edition)</title>
  <style>
    /* RESET & BASE */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    html, body {
      overflow: hidden;
      overscroll-behavior: none;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #e6f7ff 0%, #f0f9ff 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
    }

    @supports (height: 100dvh) {
      html, body { height: 100dvh; }
    }

    /* GAME CONTAINER */
    #gameContainer {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    @supports (height: 100dvh) {
      #gameContainer { height: 100dvh; }
    }

    /* GAME FRAME */
    #gameFrame {
      width: min(1200px, 100vw);
      height: min(800px, 100%);
      margin: auto;
      border-radius: 20px;
      overflow: hidden;
      background: white;
      box-shadow: 0 20px 60px rgba(0, 100, 200, 0.1);
      position: relative;
    }

    /* CANVAS */
    canvas {
      display: block;
      width: 100%;
      height: 100%;
      touch-action: none;
      position: relative;
      z-index: 1;
    }

    /* UI OVERLAY */
    .ui-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 10; /* IMPORTANT: keep UI above canvas */
    }
    .ui-overlay * { pointer-events: auto; }

    /* COPYRIGHT - SINGLE LOCATION */
    .copyright {
      position: absolute;
      bottom: 12px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 10px;
      opacity: 0.35;
      color: #666;
      pointer-events: none;
      z-index: 1000;
    }

    /* MODALS */
    .modal {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.98);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 100;
    }
    .modal.active { opacity: 1; pointer-events: all; }

    .modal-content {
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    /* BUTTONS */
    .btn {
      background: #4a9eff;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 16px 32px;
      font-size: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 4px 15px rgba(74, 158, 255, 0.2);
      min-height: 60px;
      min-width: 180px;
    }
    .btn:hover, .btn:active {
      background: #2d8cff;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 158, 255, 0.3);
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-icon { font-size: 24px; }

    /* MODE CARDS */
    .mode-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    .mode-card {
      background: #f8fbff;
      border: 3px solid #e1f0ff;
      border-radius: 20px;
      padding: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    .mode-card:hover {
      border-color: #4a9eff;
      transform: translateY(-5px);
    }
    .mode-card.selected {
      border-color: #4a9eff;
      background: #e8f3ff;
      box-shadow: 0 10px 30px rgba(74, 158, 255, 0.15);
    }
    .mode-emoji { font-size: 50px; }
    .mode-title { font-size: 22px; font-weight: 600; color: #1a5fb4; }

    /* DIFFICULTY */
    .difficulty-selector {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    .difficulty-bubble {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #e1f0ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 600;
      color: #4a9eff;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .difficulty-bubble:hover { transform: scale(1.1); }
    .difficulty-bubble.selected {
      background: #4a9eff;
      color: white;
      box-shadow: 0 5px 15px rgba(74, 158, 255, 0.3);
    }

    /* SESSION LENGTH */
    .session-length {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    .session-btn {
      padding: 15px 30px;
      background: #f0f9ff;
      border: 2px solid #c2e0ff;
      border-radius: 15px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }
    .session-btn:hover { border-color: #4a9eff; transform: translateY(-2px); }
    .session-btn.selected {
      background: #4a9eff;
      color: white;
      border-color: #4a9eff;
    }

    /* TOGGLE */
    .toggle { display: flex; align-items: center; gap: 15px; margin: 20px 0; justify-content: center; }
    .toggle-switch {
      width: 60px;
      height: 34px;
      background: #e1f0ff;
      border-radius: 17px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .toggle-switch.active { background: #4a9eff; }
    .toggle-slider {
      width: 30px;
      height: 30px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .toggle-switch.active .toggle-slider { transform: translateX(26px); }

    /* HUD */
    .hud {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 30px;
      pointer-events: none;
      z-index: 120;
    }
    .hud > * { pointer-events: auto; }

    .hud-left, .hud-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .hud-item {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: 600;
      color: #1a5fb4;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 8px;
      border: none;
    }
    .hud-emoji { font-size: 24px; }

    /* TOAST */
    .toast {
      position: fixed;
      top: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 18px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      z-index: 2000;
      max-width: 90vw;
      text-align: center;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* CAREGIVER GATE */
    .caregiver-gate {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.98);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 30px;
      z-index: 150;
      pointer-events: all;
    }
    .gate-question {
      font-size: 48px;
      font-weight: 600;
      color: #1a5fb4;
      margin: 20px 0;
    }
    .gate-input {
      font-size: 40px;
      width: 200px;
      text-align: center;
      padding: 15px;
      border: 3px solid #4a9eff;
      border-radius: 15px;
      background: #f8fbff;
    }

    /* CAREGIVER PANEL */
    .caregiver-panel {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }
    .panel-title {
      font-size: 28px;
      font-weight: 600;
      color: #1a5fb4;
      margin-bottom: 30px;
      text-align: center;
    }
    .panel-section {
      margin: 25px 0;
      padding: 20px;
      background: #f8fbff;
      border-radius: 15px;
    }
    .panel-label {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #1a5fb4;
      margin-bottom: 15px;
    }
    .slider {
      width: 100%;
      height: 40px;
      -webkit-appearance: none;
      appearance: none;
      background: #e1f0ff;
      border-radius: 20px;
      outline: none;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 40px;
      height: 40px;
      background: #4a9eff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(74, 158, 255, 0.3);
    }
    .select {
      width: 100%;
      padding: 12px 20px;
      font-size: 18px;
      border: 2px solid #c2e0ff;
      border-radius: 10px;
      background: white;
      color: #1a5fb4;
    }
    .reset-confirm {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
    }
    .reset-confirm:hover { background: #ff5252; transform: scale(1.05); }

    /* GUIDED PROMPT */
    .guided-prompt {
      position: absolute;
      bottom: 100px;
      left: 0;
      right: 0;
      text-align: center;
      pointer-events: none;
      z-index: 110;
    }
    .prompt-bubble {
      display: inline-block;
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #4a9eff;
      border-radius: 25px;
      padding: 20px 40px;
      font-size: 24px;
      color: #1a5fb4;
      box-shadow: 0 10px 30px rgba(74, 158, 255, 0.2);
      max-width: 80%;
      pointer-events: auto;
    }

    /* RESULTS */
    .results-stars {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 40px 0;
    }
    .star {
      font-size: 60px;
      color: #ffd700;
      filter: drop-shadow(0 5px 15px rgba(255, 215, 0, 0.3));
    }

    /* IN-GAME ELEMENTS */
    .replay-btn {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #4a9eff;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(74, 158, 255, 0.2);
      z-index: 115;
    }

    .continue-modal {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 500px;
      width: 90vw;
    }

    /* MOBILE */
    @media (max-width: 768px) {
      .mode-cards { grid-template-columns: 1fr; }
      .btn {
        padding: 14px 24px;
        font-size: 18px;
        min-height: 55px;
        min-width: 160px;
      }
      .hud { padding: 0 15px; }
      .hud-item { padding: 10px 15px; font-size: 16px; }
      .prompt-bubble { font-size: 20px; padding: 15px 30px; }
      .difficulty-bubble { width: 45px; height: 45px; font-size: 20px; }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body>
  <div id="gameContainer">
    <div id="gameFrame">
      <canvas id="gameCanvas"></canvas>

      <div class="ui-overlay">
        <div class="copyright">¬© Western Autism Parents Support (WAPS)</div>

        <!-- Level Select -->
        <div id="levelSelectModal" class="modal active">
          <div class="modal-content">
            <h1 style="font-size: 42px; color: #1a5fb4; text-align: center; margin: 20px 0;">Joyful Journeys</h1>
            <p style="font-size: 20px; color: #666; text-align: center; margin-bottom: 40px;">Choose your adventure!</p>

            <div class="mode-cards">
              <div class="mode-card" data-mode="1">
                <div class="mode-emoji">üòä</div>
                <div class="mode-title">Emotion Match</div>
              </div>
              <div class="mode-card" data-mode="2">
                <div class="mode-emoji">üîä</div>
                <div class="mode-title">Sound & Attention</div>
              </div>
              <div class="mode-card" data-mode="3">
                <div class="mode-emoji">üõ§Ô∏è</div>
                <div class="mode-title">Follow The Path</div>
              </div>
              <div class="mode-card" data-mode="4">
                <div class="mode-emoji">üöÇ</div>
                <div class="mode-title">Turn-Taking Train</div>
              </div>
              <div class="mode-card" data-mode="5">
                <div class="mode-emoji">ü§î</div>
                <div class="mode-title">Request & Choose</div>
              </div>
            </div>

            <div style="text-align: center; margin: 40px 0;">
              <div class="difficulty-selector">
                <div class="difficulty-bubble" data-difficulty="1">1</div>
                <div class="difficulty-bubble" data-difficulty="2">2</div>
                <div class="difficulty-bubble" data-difficulty="3">3</div>
                <div class="difficulty-bubble" data-difficulty="4">4</div>
                <div class="difficulty-bubble" data-difficulty="5">5</div>
              </div>
              <p style="font-size: 18px; color: #666; margin-top: 10px;">Difficulty</p>
            </div>

            <div style="text-align: center; margin: 40px 0;">
              <div class="session-length">
                <div class="session-btn" data-length="short">Short (2 min)</div>
                <div class="session-btn" data-length="medium">Medium (5 min)</div>
                <div class="session-btn" data-length="free">Free Play</div>
              </div>
              <p style="font-size: 18px; color: #666; margin-top: 10px;">Session Length</p>
            </div>

            <div style="text-align: center; margin: 40px 0;">
              <div class="toggle">
                <div class="toggle-label" style="font-size: 20px; color: #1a5fb4;">Guided Play</div>
                <div class="toggle-switch" id="guidedToggle">
                  <div class="toggle-slider"></div>
                </div>
              </div>
            </div>

            <div style="text-align: center; margin: 50px 0;">
              <button id="startBtn" class="btn">
                <span class="btn-icon">‚ñ∂Ô∏è</span>
                <span>Start Game</span>
              </button>
            </div>

            <div style="position: absolute; top: 30px; right: 30px;">
              <button id="muteBtn" class="btn" style="min-width: auto; padding: 12px 20px;">
                <span class="btn-icon" id="muteIcon">üîä</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Game HUD -->
        <div id="gameHUD" class="hud" style="display: none;">
          <div class="hud-left">
            <div class="hud-item">
              <span class="hud-emoji">‚≠ê</span>
              <span id="score">0</span>
            </div>
            <div class="hud-item">
              <span class="hud-emoji">üîÑ</span>
              <span id="roundCounter">1/8</span>
            </div>
          </div>
          <div class="hud-right">
            <button id="pauseBtn" class="hud-item" style="cursor: pointer;">
              <span class="btn-icon">‚è∏Ô∏è</span>
            </button>
            <button id="hudMuteBtn" class="hud-item" style="cursor: pointer;">
              <span class="btn-icon" id="hudMuteIcon">üîä</span>
            </button>
          </div>
        </div>

        <!-- Guided Prompt -->
        <div id="guidedPrompt" class="guided-prompt" style="display: none;">
          <div class="prompt-bubble" id="guidedText">It's your turn! Tap the highlighted spot.</div>
        </div>

        <!-- Replay Button (Sound Mode) -->
        <button id="replayBtn" class="replay-btn" style="display: none;">üîÑ</button>

        <!-- Pause Modal -->
        <div id="pauseModal" class="modal">
          <div class="modal-content" style="text-align: center;">
            <h2 style="font-size: 36px; color: #1a5fb4; margin: 30px 0;">Paused</h2>
            <div style="margin: 50px 0;">
              <button id="resumeBtn" class="btn" style="margin: 15px;">
                <span class="btn-icon">‚ñ∂Ô∏è</span><span>Resume</span>
              </button>
              <button id="quitBtn" class="btn" style="margin: 15px;">
                <span class="btn-icon">üè†</span><span>Quit to Menu</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Results Modal -->
        <div id="resultsModal" class="modal">
          <div class="modal-content" style="text-align: center;">
            <h2 style="font-size: 36px; color: #1a5fb4; margin: 30px 0;">Great Job!</h2>

            <div class="results-stars">
              <div class="star">‚≠ê</div><div class="star">‚≠ê</div><div class="star">‚≠ê</div><div class="star">‚≠ê</div><div class="star">‚≠ê</div>
            </div>

            <div id="resultsScore" style="font-size: 28px; color: #1a5fb4; margin: 20px 0; font-weight: 600;">
              Score: <span id="finalScore">0</span>
            </div>

            <p style="font-size: 24px; color: #666; margin: 30px 0;">Skills practiced today:</p>
            <div id="skillsIcons" style="font-size: 50px; margin: 30px 0;">üòä</div>

            <div style="margin: 50px 0;">
              <button id="playAgainBtn" class="btn" style="margin: 15px;">
                <span class="btn-icon">üîÑ</span><span>Play Again</span>
              </button>
              <button id="menuBtn" class="btn" style="margin: 15px;">
                <span class="btn-icon">üè†</span><span>Back to Menu</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Continue Playing Modal -->
        <div id="continueModal" class="modal">
          <div class="continue-modal">
            <h2 style="font-size: 36px; color: #1a5fb4; margin: 20px 0;">Great Work!</h2>
            <p style="font-size: 24px; color: #666; margin: 30px 0;">Would you like to keep playing?</p>
            <div style="margin: 40px 0;">
              <button id="continueYesBtn" class="btn" style="margin: 15px;">
                <span class="btn-icon">‚ñ∂Ô∏è</span><span>Yes, Continue!</span>
              </button>
              <button id="continueNoBtn" class="btn" style="margin: 15px;">
                <span class="btn-icon">üèÅ</span><span>Finish Session</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Caregiver Gate -->
        <div id="caregiverGate" class="modal">
          <div class="caregiver-gate">
            <h2 style="font-size: 32px; color: #1a5fb4;">Caregiver Access</h2>
            <p style="font-size: 20px; color: #666; text-align: center;">Answer the question to continue:</p>
            <div class="gate-question" id="gateQuestion">7 + 2 = ?</div>
            <input type="number" class="gate-input" id="gateAnswer" placeholder="?" />
            <button id="submitGateBtn" class="btn"><span>Submit</span></button>
          </div>
        </div>

        <!-- Caregiver Panel -->
        <div id="caregiverPanel" class="modal">
          <div class="caregiver-panel">
            <h2 class="panel-title">Caregiver Settings</h2>

            <div class="panel-section">
              <label class="panel-label">Master Volume</label>
              <input type="range" class="slider" id="volumeSlider" min="0" max="100" value="50" />
              <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                <span>üîà</span><span id="volumeValue">50%</span><span>üîä</span>
              </div>
            </div>

            <div class="panel-section">
              <label class="panel-label">Animation Intensity</label>
              <select class="select" id="animationIntensity">
                <option value="low">Low (Reduced Motion)</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>

            <div class="panel-section">
              <label class="panel-label">Visual Contrast</label>
              <select class="select" id="visualContrast">
                <option value="normal" selected>Normal</option>
                <option value="high">High Contrast</option>
              </select>
            </div>

            <div class="panel-section">
              <div class="toggle">
                <div class="panel-label">Enable Hints</div>
                <div class="toggle-switch active" id="hintsToggle">
                  <div class="toggle-slider"></div>
                </div>
              </div>
            </div>

            <div class="panel-section">
              <h3 class="panel-label">Progress Tracking</h3>
              <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 10px; font-size: 16px;">
                <div>Total Sessions: <span id="progressSessions">0</span></div>
                <div>Emotion Matches: <span id="progressMode1">0</span></div>
                <div>Sound Games: <span id="progressMode2">0</span></div>
                <div>Path Games: <span id="progressMode3">0</span></div>
              </div>
              <button id="copyProgressBtn" class="btn" style="width: 100%; margin: 10px 0;">
                <span class="btn-icon">üìã</span><span>Copy Progress to Clipboard</span>
              </button>
              <button id="resetProgressBtn" class="btn" style="width: 100%; margin: 10px 0; background: #ff6b6b;">
                <span class="btn-icon">üîÑ</span><span>Reset Progress</span>
              </button>
              <div id="resetConfirm" style="display: none; text-align: center; margin-top: 20px;">
                <p style="color: #666; margin-bottom: 10px;">Tap again within 2.5 seconds to confirm</p>
                <button id="confirmResetBtn" class="reset-confirm">Confirm Reset</button>
              </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
              <button id="closePanelBtn" class="btn"><span>Close Panel</span></button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    'use strict';

    // ============ GAME CONSTANTS ============
    const GameState = {
      levelSelect: 'levelSelect',
      playing: 'playing',
      paused: 'paused',
      results: 'results',
      caregiver: 'caregiver',
      continue: 'continue'
    };

    const Modes = {
      1: { name: 'Emotion Match', emoji: 'üòä', bg: '#fff0f5' },
      2: { name: 'Sound & Attention', emoji: 'üîä', bg: '#f0fff4' },
      3: { name: 'Follow The Path', emoji: 'üõ§Ô∏è', bg: '#fffaf0' },
      4: { name: 'Turn-Taking Train', emoji: 'üöÇ', bg: '#f0f8ff' },
      5: { name: 'Request & Choose', emoji: 'ü§î', bg: '#f8f0ff' }
    };

    const Emotions = [
      { emoji: 'üòä', name: 'Happy' },
      { emoji: 'üò¢', name: 'Sad' },
      { emoji: 'üò†', name: 'Angry' },
      { emoji: 'üò¥', name: 'Sleepy' },
      { emoji: 'üò≤', name: 'Surprised' },
      { emoji: 'üò∞', name: 'Worried' },
      { emoji: 'üòé', name: 'Cool' },
      { emoji: 'ü•∞', name: 'Loving' }
    ];

    const SoundEmojis = [
      { emoji: 'üê¶', sound: 'bird' },
      { emoji: 'üö≤', sound: 'bell' },
      { emoji: 'üöö', sound: 'truck' },
      { emoji: 'üêï', sound: 'dog' },
      { emoji: 'üöó', sound: 'horn' }
    ];

    const RequestItems = ['üçé','üöó','‚öΩ','üìö','üíß','üõèÔ∏è','üç™','üé®','üß∏','ü•§'];

    // ============ GAME CLASS ============
    class JoyfulJourneysGame {
      constructor() {
        // Game State
        this.state = GameState.levelSelect;
        this.currentMode = 1;
        this.difficulty = 1;
        this.sessionLength = 'medium';
        this.guidedPlay = false;
        this.muted = false;
        this.volume = 0.5;
        this.animationIntensity = 'medium';
        this.visualContrast = 'normal';
        this.hintsEnabled = true;

        // Session State
        this.score = 0;
        this.currentRound = 0;
        this.totalRounds = 8;
        this.roundStartTime = 0;
        this.sessionStartTime = 0;
        this.sessionDuration = 300000; // 5 min default
        this.roundData = [];
        this.roundComplete = false;

        // Mode-specific State
        this.targetEmotion = null;
        this.emotionOptions = [];
        this.targetSound = null;
        this.soundOptions = [];
        this.pathDots = [];
        this.currentDot = 0;
        this.trainPieces = 0;
        this.trainProgress = 0;
        this.playerTurn = true;
        this.requestTarget = null;
        this.requestOptions = [];
        this.pleaseStep = false;

        // Timing
        this.hintTimer = null;
        this.friendTurnTimer = null;
        this.soundPlayTimer = null;

        // Canvas
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.dpr = window.devicePixelRatio || 1;
        this.resizeDebounce = null;

        // Audio
        this.audioContext = null;
        this.masterGain = null;
        this.audioInitialized = false;

        // Progress
        this.progress = this.loadProgress();

        // Caregiver
        this.caregiverHoldTimer = null;
        this.correctGateAnswer = 0;

        // Bind Methods
        this.gameLoop = this.gameLoop.bind(this);
        this.handleResize = this.handleResize.bind(this);
        this.handlePointerDown = this.handlePointerDown.bind(this);
        this.handleUIDown = this.handleUIDown.bind(this);

        // Initialize
        this.init();
        this.startGameLoop();
      }

      init() {
        this.setupEventListeners();
        this.handleResize();
        this.updateProgressDisplay();

        // Default selections visually
        this.updateModeSelection();
        this.updateDifficultySelection();
        this.updateSessionSelection();

        // Apply reduced motion preference
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          this.animationIntensity = 'low';
          const sel = document.getElementById('animationIntensity');
          if (sel) sel.value = 'low';
        }
      }

      setupEventListeners() {
        window.addEventListener('resize', this.handleResize);
        window.addEventListener('orientationchange', this.handleResize);
        if (window.visualViewport) window.visualViewport.addEventListener('resize', this.handleResize);

        // Canvas input
        this.canvas.addEventListener('pointerdown', this.handlePointerDown);

        // UI clicks (capture spans/icons too)
        document.addEventListener('pointerdown', this.handleUIDown);

        // Initialize audio on first user interaction
        const initAudio = () => {
          if (!this.audioInitialized) {
            this.initAudio();
            document.removeEventListener('pointerdown', initAudio);
          }
        };
        document.addEventListener('pointerdown', initAudio);

        // Caregiver hold: top-left corner hold 2s
        this.canvas.addEventListener('pointerdown', (e) => {
          const rect = this.canvas.getBoundingClientRect();
          const localX = e.clientX - rect.left;
          const localY = e.clientY - rect.top;
          if (localX < 50 && localY < 50) {
            clearTimeout(this.caregiverHoldTimer);
            this.caregiverHoldTimer = setTimeout(() => this.showCaregiverGate(), 2000);
          }
        });
        const cancelHold = () => { clearTimeout(this.caregiverHoldTimer); this.caregiverHoldTimer = null; };
        this.canvas.addEventListener('pointerup', cancelHold);
        this.canvas.addEventListener('pointercancel', cancelHold);
        this.canvas.addEventListener('pointerleave', cancelHold);

        // Sliders/selects should use input/change events (not pointerdown)
        const volumeSlider = document.getElementById('volumeSlider');
        volumeSlider.addEventListener('input', (ev) => {
          const v = Number(ev.target.value);
          document.getElementById('volumeValue').textContent = `${v}%`;
          this.setVolume(v / 100);
        });

        document.getElementById('animationIntensity').addEventListener('change', (ev) => {
          this.animationIntensity = ev.target.value;
        });
        document.getElementById('visualContrast').addEventListener('change', (ev) => {
          this.visualContrast = ev.target.value;
        });
      }

      // ===== UI HANDLING (FIXED) =====
      handleUIDown(e) {
        const t = e.target;

        // Mode selection
        const modeCard = t.closest('.mode-card');
        if (modeCard) {
          this.currentMode = parseInt(modeCard.dataset.mode, 10);
          this.updateModeSelection();
          return;
        }

        // Difficulty selection
        const diffBubble = t.closest('.difficulty-bubble');
        if (diffBubble) {
          this.difficulty = parseInt(diffBubble.dataset.difficulty, 10);
          this.updateDifficultySelection();
          return;
        }

        // Session length selection
        const sessionBtn = t.closest('.session-btn');
        if (sessionBtn) {
          this.sessionLength = sessionBtn.dataset.length;
          this.updateSessionSelection();
          switch (this.sessionLength) {
            case 'short': this.sessionDuration = 120000; break;
            case 'medium': this.sessionDuration = 300000; break;
            case 'free': this.sessionDuration = Infinity; break;
          }
          return;
        }

        // Guided Play toggle (ONLY menu)
        if (t.closest('#guidedToggle')) {
          this.guidedPlay = !this.guidedPlay;
          document.getElementById('guidedToggle').classList.toggle('active', this.guidedPlay);
          return;
        }

        // Hints toggle (caregiver)
        if (t.closest('#hintsToggle')) {
          this.hintsEnabled = !this.hintsEnabled;
          document.getElementById('hintsToggle').classList.toggle('active', this.hintsEnabled);
          return;
        }

        // Replay
        if (t.closest('#replayBtn')) return this.playTargetSound();

        // Buttons (use closest so clicking on inner spans works)
        if (t.closest('#startBtn')) return this.startGame();
        if (t.closest('#pauseBtn')) return this.pauseGame();
        if (t.closest('#resumeBtn')) return this.resumeGame();
        if (t.closest('#quitBtn')) return this.quitToMenu();
        if (t.closest('#playAgainBtn')) return this.playAgain();
        if (t.closest('#menuBtn')) return this.quitToMenu();
        if (t.closest('#muteBtn') || t.closest('#hudMuteBtn')) return this.toggleMute();
        if (t.closest('#submitGateBtn')) return this.submitGateAnswer();
        if (t.closest('#closePanelBtn')) return this.closeCaregiverPanel();
        if (t.closest('#copyProgressBtn')) return this.copyProgress();
        if (t.closest('#resetProgressBtn')) return this.showResetConfirm();
        if (t.closest('#confirmResetBtn')) return this.resetProgress();
        if (t.closest('#continueYesBtn')) return this.continuePlaying();
        if (t.closest('#continueNoBtn')) return this.showResults();
      }

      // ===== CANVAS RESIZE (FIXED) =====
      handleResize() {
        if (this.resizeDebounce) cancelAnimationFrame(this.resizeDebounce);

        this.resizeDebounce = requestAnimationFrame(() => {
          // Recompute DPR each time
          this.dpr = window.devicePixelRatio || 1;

          const rect = this.canvas.parentElement.getBoundingClientRect();
          const cssW = Math.max(1, rect.width);
          const cssH = Math.max(1, rect.height);

          this.canvas.style.width = cssW + 'px';
          this.canvas.style.height = cssH + 'px';

          this.canvas.width = Math.floor(cssW * this.dpr);
          this.canvas.height = Math.floor(cssH * this.dpr);

          this.ctx.setTransform(this.dpr, 0, 0, this.dpr, 0, 0);
        });
      }

      // ===== CANVAS INPUT =====
      handlePointerDown(e) {
        const rect = this.canvas.getBoundingClientRect();
        const cssW = rect.width || 1;
        const cssH = rect.height || 1;
        const worldW = this.canvas.width / this.dpr;
        const worldH = this.canvas.height / this.dpr;

        const x = (e.clientX - rect.left) * (worldW / cssW);
        const y = (e.clientY - rect.top) * (worldH / cssH);

        if (this.state === GameState.playing && !this.roundComplete) {
          this.handleGameInteraction(x, y);
        }
      }

      // ============ GAME MODE IMPLEMENTATIONS ============
      startRound() {
        this.roundStartTime = Date.now();
        this.roundComplete = false;
        clearTimeout(this.hintTimer);
        clearTimeout(this.friendTurnTimer);
        clearTimeout(this.soundPlayTimer);

        const width = this.canvas.width / this.dpr;
        const height = this.canvas.height / this.dpr;
        const centerY = height / 2;

        // Hide replay by default; only show for sound mode
        document.getElementById('replayBtn').style.display = 'none';

        switch (this.currentMode) {
          case 1: { // Emotion Match
            const availableEmotions = Emotions.slice(0, Math.min(Emotions.length, 2 + this.difficulty));
            this.targetEmotion = availableEmotions[Math.floor(Math.random() * availableEmotions.length)];

            this.emotionOptions = [this.targetEmotion];
            while (this.emotionOptions.length < Math.min(4, 2 + this.difficulty)) {
              const rnd = availableEmotions[Math.floor(Math.random() * availableEmotions.length)];
              if (!this.emotionOptions.find(e => e.emoji === rnd.emoji)) this.emotionOptions.push(rnd);
            }
            this.emotionOptions.sort(() => Math.random() - 0.5);

            if (this.hintsEnabled && this.difficulty <= 2) {
              this.hintTimer = setTimeout(() => this.showToast("Hint: Look for the matching face!"), 3000);
            }
            break;
          }
          case 2: { // Sound & Attention
            const availableSounds = SoundEmojis.slice(0, Math.min(5, 2 + this.difficulty));
            this.targetSound = availableSounds[Math.floor(Math.random() * availableSounds.length)];
            this.soundOptions = [...availableSounds];

            this.soundPlayTimer = setTimeout(() => this.playTargetSound(), 500);
            document.getElementById('replayBtn').style.display = 'flex';

            if (this.hintsEnabled && this.difficulty <= 2) {
              this.hintTimer = setTimeout(() => this.showToast("Hint: Listen carefully!"), 4000);
            }
            break;
          }
          case 3: { // Follow The Path
            this.pathDots = [];
            this.currentDot = 0;
            const dotCount = 5 + this.difficulty * 2;
            for (let i = 0; i < dotCount; i++) {
              const t = i / (dotCount - 1);
              const x = 100 + t * (width - 200);
              const y = centerY + Math.sin(t * Math.PI * 2) * 100;
              this.pathDots.push({ x, y, radius: 40, completed: false });
            }
            break;
          }
          case 4: { // Turn-Taking Train
            this.trainPieces = 4 + this.difficulty;
            this.trainProgress = 0;
            this.playerTurn = true;

            if (this.guidedPlay) {
              document.getElementById('guidedText').textContent = "My turn!";
              document.getElementById('guidedPrompt').style.display = 'block';
            } else {
              document.getElementById('guidedPrompt').style.display = 'none';
            }
            break;
          }
          case 5: { // Request & Choose
            const availableItems = RequestItems.slice(0, Math.min(10, 2 + this.difficulty * 2));
            this.requestTarget = availableItems[Math.floor(Math.random() * availableItems.length)];

            this.requestOptions = [this.requestTarget];
            while (this.requestOptions.length < Math.min(4, 2 + this.difficulty)) {
              const rnd = availableItems[Math.floor(Math.random() * availableItems.length)];
              if (!this.requestOptions.includes(rnd)) this.requestOptions.push(rnd);
            }
            this.requestOptions.sort(() => Math.random() - 0.5);

            this.pleaseStep = this.difficulty >= 5;
            break;
          }
        }
      }

      handleGameInteraction(x, y) {
        switch (this.currentMode) {
          case 1: return this.handleEmotionMatch(x, y);
          case 2: return this.handleSoundAttention(x, y);
          case 3: return this.handleFollowPath(x, y);
          case 4: return this.handleTurnTaking(x, y);
          case 5: return this.handleRequestChoose(x, y);
        }
      }

      handleEmotionMatch(x, y) {
        const width = this.canvas.width / this.dpr;
        const height = this.canvas.height / this.dpr;
        const centerX = width / 2;
        const optionCount = this.emotionOptions.length;
        const optionSize = 80;
        const spacing = 100;

        for (let i = 0; i < optionCount; i++) {
          const optionX = centerX + (i - (optionCount - 1) / 2) * spacing;
          const optionY = height - 150;

          if (Math.abs(x - optionX) < optionSize / 2 && Math.abs(y - optionY) < optionSize / 2) {
            const selected = this.emotionOptions[i];
            if (selected.emoji === this.targetEmotion.emoji) {
              this.playSound('correct');
              this.score += 10 * this.difficulty;
              this.showToast("Great job! That's how I feel!");
              this.roundComplete = true;
              setTimeout(() => this.nextRound(), 900);
            } else {
              this.playSound('tryagain');
              this.showToast("Try again! How do I feel?");
            }
            return;
          }
        }
      }

      handleSoundAttention(x, y) {
        const width = this.canvas.width / this.dpr;
        const height = this.canvas.height / this.dpr;
        const optionCount = this.soundOptions.length;
        const optionSize = 100;
        const spacing = 120;
        const startX = width / 2 - ((optionCount - 1) * spacing) / 2;

        for (let i = 0; i < optionCount; i++) {
          const optionX = startX + i * spacing;
          const optionY = height - 200;

          if (Math.abs(x - optionX) < optionSize / 2 && Math.abs(y - optionY) < optionSize / 2) {
            const selected = this.soundOptions[i];
            if (selected.sound === this.targetSound.sound) {
              this.playSound('correct');
              this.score += 10 * this.difficulty;
              this.showToast("Excellent listening!");
              document.getElementById('replayBtn').style.display = 'none';
              this.roundComplete = true;
              setTimeout(() => this.nextRound(), 900);
            } else {
              this.playSound('tryagain');
              this.showToast("Listen again...");
              setTimeout(() => this.playTargetSound(), 450);
            }
            return;
          }
        }
      }

      handleFollowPath(x, y) {
        if (this.currentDot >= this.pathDots.length) return;

        const currentTarget = this.pathDots[this.currentDot];
        const distance = Math.hypot(x - currentTarget.x, y - currentTarget.y);

        if (distance < currentTarget.radius) {
          this.pathDots[this.currentDot].completed = true;
          this.currentDot++;
          this.playSound('correct');

          if (this.currentDot >= this.pathDots.length) {
            this.score += 15 * this.difficulty;
            this.showToast("You followed the path!");
            this.roundComplete = true;
            setTimeout(() => this.nextRound(), 900);
          }
        } else if (this.currentDot > 0) {
          // gentle reminder only if tap is not near any dot
          this.playSound('tryagain');
          this.showToast("Follow the dots in order!");
        }
      }

      handleTurnTaking(x, y) {
        if (!this.playerTurn || this.trainProgress >= this.trainPieces) return;

        const width = this.canvas.width / this.dpr;
        const pieceWidth = (width - 200) / this.trainPieces;
        const targetX = 100 + (this.trainProgress + 0.5) * pieceWidth;
        const targetY = this.canvas.height / (2 * this.dpr);

        if (Math.abs(x - targetX) < pieceWidth / 2 && Math.abs(y - targetY) < 60) {
          this.trainProgress++;
          this.playSound('correct');

          this.playerTurn = false;
          if (this.guidedPlay) {
            document.getElementById('guidedText').textContent = "Friend's turn...";
            document.getElementById('guidedPrompt').style.display = 'block';
          }

          // Friend's turn after fixed gentle delay range (not per-frame random)
          const delay = 1000 + Math.floor(Math.random() * 450);
          this.friendTurnTimer = setTimeout(() => {
            if (this.trainProgress < this.trainPieces) {
              this.trainProgress++;
              this.playerTurn = true;

              if (this.guidedPlay) {
                document.getElementById('guidedText').textContent = "My turn!";
                document.getElementById('guidedPrompt').style.display = 'block';
              }

              if (this.trainProgress >= this.trainPieces) {
                this.score += 12 * this.difficulty;
                this.showToast("Great teamwork!");
                this.roundComplete = true;
                setTimeout(() => this.nextRound(), 900);
              }
            }
          }, delay);
        }
      }

      handleRequestChoose(x, y) {
        const width = this.canvas.width / this.dpr;
        const height = this.canvas.height / this.dpr;
        const optionCount = this.requestOptions.length;
        const optionSize = 80;
        const spacing = 100;
        const centerX = width / 2;

        if (this.pleaseStep) {
          const pleaseX = centerX;
          const pleaseY = height - 100;
          if (Math.abs(x - pleaseX) < 60 && Math.abs(y - pleaseY) < 30) {
            this.playSound('correct');
            this.score += 15 * this.difficulty;
            this.showToast("Perfect! You asked so nicely!");
            this.roundComplete = true;
            setTimeout(() => this.nextRound(), 900);
          }
          return;
        }

        for (let i = 0; i < optionCount; i++) {
          const optionX = centerX + (i - (optionCount - 1) / 2) * spacing;
          const optionY = height - 200;
          const item = this.requestOptions[i];

          if (Math.abs(x - optionX) < optionSize / 2 && Math.abs(y - optionY) < optionSize / 2) {
            if (item === this.requestTarget) {
              this.playSound('correct');
              this.score += 10 * this.difficulty;
              this.showToast("Great choice!");
              this.roundComplete = true;
              setTimeout(() => this.nextRound(), 900);
            } else {
              this.playSound('tryagain');
              this.showToast("Try again! What do I want?");
            }
            return;
          }
        }
      }

      // ============ AUDIO SYSTEM ============
      initAudio() {
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          this.masterGain = this.audioContext.createGain();
          this.masterGain.connect(this.audioContext.destination);
          this.masterGain.gain.value = this.muted ? 0 : this.volume * 0.25;
          this.audioInitialized = true;
        } catch (e) {
          console.warn('Web Audio API not available:', e);
        }
      }

      playSound(type) {
        if (!this.audioContext || this.muted) return;
        try {
          const now = this.audioContext.currentTime;
          switch (type) {
            case 'correct': return this.playCorrectSound(now);
            case 'tryagain': return this.playTryAgainSound(now);
            case 'bird': return this.playBirdSound(now);
            case 'bell': return this.playBellSound(now);
            case 'truck': return this.playTruckSound(now);
            case 'dog': return this.playDogSound(now);
            case 'horn': return this.playHornSound(now);
          }
        } catch (e) {
          console.warn('Audio playback failed:', e);
        }
      }

      playTargetSound() {
        if (this.targetSound) this.playSound(this.targetSound.sound);
      }

      playCorrectSound(time) {
        const osc = this.audioContext.createOscillator();
        const gain = this.audioContext.createGain();
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.frequency.setValueAtTime(523.25, time);
        osc.type = 'sine';
        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(this.volume * 0.15, time + 0.08);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.55);
        osc.start(time);
        osc.stop(time + 0.55);
      }

      playTryAgainSound(time) {
        const osc = this.audioContext.createOscillator();
        const gain = this.audioContext.createGain();
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.frequency.setValueAtTime(392, time);
        osc.frequency.exponentialRampToValueAtTime(349.23, time + 0.22);
        osc.type = 'sine';
        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(this.volume * 0.10, time + 0.04);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.35);
        osc.start(time);
        osc.stop(time + 0.35);
      }

      playBirdSound(time) {
        for (let i = 0; i < 3; i++) {
          const osc = this.audioContext.createOscillator();
          const gain = this.audioContext.createGain();
          osc.connect(gain);
          gain.connect(this.masterGain);

          const startTime = time + i * 0.15;
          osc.frequency.setValueAtTime(900 + i * 100, startTime);
          osc.frequency.exponentialRampToValueAtTime(1800, startTime + 0.10);
          osc.type = 'sine';

          gain.gain.setValueAtTime(0, startTime);
          gain.gain.linearRampToValueAtTime(this.volume * 0.08, startTime + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.12);

          osc.start(startTime);
          osc.stop(startTime + 0.12);
        }
      }

      playBellSound(time) {
        for (let i = 0; i < 2; i++) {
          const osc = this.audioContext.createOscillator();
          const gain = this.audioContext.createGain();
          osc.connect(gain);
          gain.connect(this.masterGain);

          const startTime = time + i * 0.20;
          osc.frequency.setValueAtTime(950 + i * 50, startTime);
          osc.type = 'triangle';

          gain.gain.setValueAtTime(0, startTime);
          gain.gain.linearRampToValueAtTime(this.volume * 0.12, startTime + 0.04);
          gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.28);

          osc.start(startTime);
          osc.stop(startTime + 0.28);
        }
      }

      playTruckSound(time) {
        const osc = this.audioContext.createOscillator();
        const lfo = this.audioContext.createOscillator();
        const lfoGain = this.audioContext.createGain();
        const gain = this.audioContext.createGain();

        osc.connect(gain);
        lfo.connect(lfoGain);
        lfoGain.connect(osc.frequency);
        gain.connect(this.masterGain);

        osc.frequency.setValueAtTime(75, time);
        osc.type = 'sawtooth';

        lfo.frequency.setValueAtTime(4.5, time);
        lfo.type = 'sine';
        lfoGain.gain.setValueAtTime(12, time);

        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(this.volume * 0.06, time + 0.25);
        gain.gain.setValueAtTime(this.volume * 0.06, time + 0.60);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.95);

        osc.start(time);
        lfo.start(time);
        osc.stop(time + 0.95);
        lfo.stop(time + 0.95);
      }

      playDogSound(time) {
        for (let i = 0; i < 2; i++) {
          const noise = this.audioContext.createBufferSource();
          const buffer = this.audioContext.createBuffer(1, 44100 * 0.15, 44100);
          const data = buffer.getChannelData(0);
          for (let j = 0; j < data.length; j++) data[j] = Math.random() * 2 - 1;

          const filter = this.audioContext.createBiquadFilter();
          const gain = this.audioContext.createGain();

          noise.buffer = buffer;
          noise.connect(filter);
          filter.connect(gain);
          gain.connect(this.masterGain);

          const startTime = time + i * 0.15;
          filter.frequency.setValueAtTime(550 + i * 50, startTime);
          filter.type = 'bandpass';
          filter.Q.value = 4;

          gain.gain.setValueAtTime(0, startTime);
          gain.gain.linearRampToValueAtTime(this.volume * 0.10, startTime + 0.04);
          gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.15);

          noise.start(startTime);
          noise.stop(startTime + 0.15);
        }
      }

      playHornSound(time) {
        const osc1 = this.audioContext.createOscillator();
        const osc2 = this.audioContext.createOscillator();
        const gain = this.audioContext.createGain();
        const filter = this.audioContext.createBiquadFilter();

        osc1.connect(filter);
        osc2.connect(filter);
        filter.connect(gain);
        gain.connect(this.masterGain);

        osc1.frequency.setValueAtTime(440, time);
        osc2.frequency.setValueAtTime(466.16, time);
        osc1.type = 'sine';
        osc2.type = 'sine';

        filter.frequency.setValueAtTime(800, time);
        filter.type = 'lowpass';

        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(this.volume * 0.10, time + 0.08);
        gain.gain.setValueAtTime(this.volume * 0.10, time + 0.20);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.45);

        osc1.start(time);
        osc2.start(time);
        osc1.stop(time + 0.45);
        osc2.stop(time + 0.45);
      }

      toggleMute() {
        this.muted = !this.muted;
        const icon = this.muted ? 'üîà' : 'üîä';
        document.getElementById('muteIcon').textContent = icon;
        document.getElementById('hudMuteIcon').textContent = icon;
        if (this.masterGain) this.masterGain.gain.value = this.muted ? 0 : this.volume * 0.25;
      }

      setVolume(value) {
        this.volume = Math.max(0, Math.min(1, value));
        if (this.masterGain && !this.muted) this.masterGain.gain.value = this.volume * 0.25;
      }

      // ============ GAME FLOW ============
      startGame() {
        this.state = GameState.playing;
        this.score = 0;
        this.currentRound = 1;
        this.roundStartTime = Date.now();
        this.sessionStartTime = Date.now();
        this.roundData = [];

        this.totalRounds = 8 + this.difficulty * 2;

        document.getElementById('levelSelectModal').classList.remove('active');
        document.getElementById('gameHUD').style.display = 'flex';
        document.getElementById('guidedPrompt').style.display = 'none';
        document.getElementById('replayBtn').style.display = 'none';

        this.progress.totalSessions++;
        this.progress.modePlays[this.currentMode]++;
        this.progress.difficultyAttempts[this.difficulty]++;
        this.saveProgress();
        this.updateProgressDisplay();

        document.getElementById('score').textContent = this.score;
        document.getElementById('roundCounter').textContent = `${this.currentRound}/${this.totalRounds}`;

        this.startRound();
      }

      nextRound() {
        const roundTime = Date.now() - this.roundStartTime;
        this.roundData.push({ mode: this.currentMode, difficulty: this.difficulty, time: roundTime, correct: true });

        this.progress.completionCounts[this.currentMode]++;
        this.progress.responseTimes.push(roundTime);
        if (this.progress.responseTimes.length > 100) this.progress.responseTimes.shift();
        this.saveProgress();

        const sessionTime = Date.now() - this.sessionStartTime;
        this.currentRound++;

        if (this.currentRound > this.totalRounds || sessionTime >= this.sessionDuration) {
          if (this.sessionLength === 'free' && this.currentRound > this.totalRounds) {
            this.showContinuePrompt();
          } else {
            this.showResults();
          }
        } else {
          this.roundStartTime = Date.now();
          document.getElementById('roundCounter').textContent = `${this.currentRound}/${this.totalRounds}`;
          document.getElementById('score').textContent = this.score;
          this.startRound();
        }
      }

      pauseGame() {
        this.state = GameState.paused;
        document.getElementById('pauseModal').classList.add('active');
      }

      resumeGame() {
        this.state = GameState.playing;
        document.getElementById('pauseModal').classList.remove('active');
      }

      quitToMenu() {
        this.state = GameState.levelSelect;
        document.getElementById('pauseModal').classList.remove('active');
        document.getElementById('resultsModal').classList.remove('active');
        document.getElementById('continueModal').classList.remove('active');
        document.getElementById('levelSelectModal').classList.add('active');
        document.getElementById('gameHUD').style.display = 'none';
        document.getElementById('guidedPrompt').style.display = 'none';
        document.getElementById('replayBtn').style.display = 'none';
      }

      playAgain() {
        this.state = GameState.levelSelect;
        document.getElementById('resultsModal').classList.remove('active');
        document.getElementById('levelSelectModal').classList.add('active');
        document.getElementById('gameHUD').style.display = 'none';
        document.getElementById('guidedPrompt').style.display = 'none';
        document.getElementById('replayBtn').style.display = 'none';
      }

      showContinuePrompt() {
        this.state = GameState.continue;
        document.getElementById('continueModal').classList.add('active');
      }

      continuePlaying() {
        this.state = GameState.playing;
        this.totalRounds += 4;
        document.getElementById('continueModal').classList.remove('active');
        this.startRound();
      }

      showResults() {
        this.state = GameState.results;
        document.getElementById('gameHUD').style.display = 'none';
        document.getElementById('guidedPrompt').style.display = 'none';
        document.getElementById('replayBtn').style.display = 'none';
        document.getElementById('continueModal').classList.remove('active');

        const avgTime = this.roundData.length
          ? this.roundData.reduce((sum, r) => sum + r.time, 0) / this.roundData.length
          : 9999;
        const timeScore = Math.max(0, 1 - avgTime / 10000);
        const starCount = Math.min(5, Math.max(1, Math.floor(timeScore * 3 + 2)));

        document.getElementById('finalScore').textContent = this.score;
        document.getElementById('skillsIcons').textContent = Modes[this.currentMode].emoji;

        const stars = document.querySelectorAll('.star');
        stars.forEach((star, i) => star.style.opacity = i < starCount ? '1' : '0.3');

        document.getElementById('resultsModal').classList.add('active');
      }

      // ============ CAREGIVER FEATURES ============
      showCaregiverGate() {
        const a = Math.floor(Math.random() * 10) + 1;
        const b = Math.floor(Math.random() * 10) + 1;
        this.correctGateAnswer = a + b;

        document.getElementById('gateQuestion').textContent = `${a} + ${b} = ?`;
        document.getElementById('gateAnswer').value = '';

        this.state = GameState.caregiver;
        document.getElementById('caregiverGate').classList.add('active');
      }

      submitGateAnswer() {
        const answer = parseInt(document.getElementById('gateAnswer').value, 10);
        if (answer === this.correctGateAnswer) {
          document.getElementById('caregiverGate').classList.remove('active');
          this.showCaregiverPanel();
        } else {
          this.showToast("Incorrect. Please try again.");
          document.getElementById('gateAnswer').value = '';
        }
      }

      showCaregiverPanel() {
        document.getElementById('caregiverPanel').classList.add('active');
        this.updateProgressDisplay();
      }

      closeCaregiverPanel() {
        document.getElementById('caregiverPanel').classList.remove('active');
        // Return to menu if caregiver opened from menu; keep current state otherwise
        if (this.state === GameState.caregiver) this.state = GameState.levelSelect;
      }

      // ============ PROGRESS TRACKING ============
      loadProgress() {
        const saved = localStorage.getItem('joyfulJourneysProgress');
        if (saved) {
          try { return JSON.parse(saved); } catch (e) {}
        }
        return {
          totalSessions: 0,
          modePlays: {1:0,2:0,3:0,4:0,5:0},
          difficultyAttempts: {1:0,2:0,3:0,4:0,5:0},
          completionCounts: {1:0,2:0,3:0,4:0,5:0},
          hintUsage: 0,
          responseTimes: []
        };
      }

      saveProgress() {
        localStorage.setItem('joyfulJourneysProgress', JSON.stringify(this.progress));
      }

      updateProgressDisplay() {
        document.getElementById('progressSessions').textContent = this.progress.totalSessions;
        document.getElementById('progressMode1').textContent = this.progress.completionCounts[1];
        document.getElementById('progressMode2').textContent = this.progress.completionCounts[2];
        document.getElementById('progressMode3').textContent = this.progress.completionCounts[3];
      }

      copyProgress() {
        const progressStr = JSON.stringify(this.progress, null, 2);
        navigator.clipboard.writeText(progressStr)
          .then(() => this.showToast('Progress copied to clipboard!'))
          .catch(() => this.showToast('Failed to copy progress.'));
      }

      showResetConfirm() {
        document.getElementById('resetConfirm').style.display = 'block';
        setTimeout(() => { document.getElementById('resetConfirm').style.display = 'none'; }, 2500);
      }

      resetProgress() {
        this.progress = {
          totalSessions: 0,
          modePlays: {1:0,2:0,3:0,4:0,5:0},
          difficultyAttempts: {1:0,2:0,3:0,4:0,5:0},
          completionCounts: {1:0,2:0,3:0,4:0,5:0},
          hintUsage: 0,
          responseTimes: []
        };
        this.saveProgress();
        this.updateProgressDisplay();
        document.getElementById('resetConfirm').style.display = 'none';
        this.showToast('Progress reset successfully.');
      }

      // ============ UI HELPERS ============
      updateModeSelection() {
        document.querySelectorAll('.mode-card').forEach(card => {
          card.classList.toggle('selected', parseInt(card.dataset.mode, 10) === this.currentMode);
        });
      }
      updateDifficultySelection() {
        document.querySelectorAll('.difficulty-bubble').forEach(b => {
          b.classList.toggle('selected', parseInt(b.dataset.difficulty, 10) === this.difficulty);
        });
      }
      updateSessionSelection() {
        document.querySelectorAll('.session-btn').forEach(btn => {
          btn.classList.toggle('selected', btn.dataset.length === this.sessionLength);
        });
      }

      showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        clearTimeout(this._toastTimer);
        this._toastTimer = setTimeout(() => toast.classList.remove('show'), 1800);
      }

      // ============ RENDERING ============
      gameLoop() {
        const width = this.canvas.width / this.dpr;
        const height = this.canvas.height / this.dpr;

        this.ctx.clearRect(0, 0, width, height);

        if (this.state === GameState.playing || this.state === GameState.paused) {
          this.drawGame(width, height);
        } else if (this.state === GameState.levelSelect) {
          this.drawLevelSelect(width, height);
        }

        requestAnimationFrame(this.gameLoop);
      }

      drawLevelSelect(width, height) {
        this.ctx.fillStyle = '#f0f9ff';
        this.ctx.fillRect(0, 0, width, height);

        this.ctx.fillStyle = 'rgba(74, 158, 255, 0.1)';
        this.ctx.beginPath();
        this.ctx.arc(100, 100, 50, 0, Math.PI * 2);
        this.ctx.fill();

        this.ctx.beginPath();
        this.ctx.arc(width - 100, height - 100, 70, 0, Math.PI * 2);
        this.ctx.fill();
      }

      drawGame(width, height) {
        const bgColor = Modes[this.currentMode].bg;
        this.ctx.fillStyle = bgColor;
        this.ctx.fillRect(0, 0, width, height);

        const centerX = width / 2;
        const centerY = height / 2;

        switch (this.currentMode) {
          case 1: this.drawEmotionMatch(width, height, centerX, centerY); break;
          case 2: this.drawSoundAttention(width, height, centerX, centerY); break;
          case 3: this.drawFollowPath(width, height, centerX, centerY); break;
          case 4: this.drawTurnTaking(width, height, centerX, centerY); break;
          case 5: this.drawRequestChoose(width, height, centerX, centerY); break;
        }
      }

      drawEmotionMatch(width, height, centerX, centerY) {
        this.ctx.fillStyle = '#1a5fb4';
        this.ctx.font = 'bold 32px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.textBaseline = 'middle';
        this.ctx.fillText("I feel...", centerX, 100);

        if (this.targetEmotion) {
          this.ctx.font = '120px Arial';
          this.ctx.fillText(this.targetEmotion.emoji, centerX, centerY - 50);

          if (this.difficulty < 4) {
            this.ctx.font = '28px Arial';
            this.ctx.fillText(this.targetEmotion.name, centerX, centerY + 50);
          }
        }

        const optionCount = this.emotionOptions.length;
        const optionSize = 80;
        const spacing = 100;

        for (let i = 0; i < optionCount; i++) {
          const optionX = centerX + (i - (optionCount - 1) / 2) * spacing;
          const optionY = height - 150;
          const emotion = this.emotionOptions[i];

          this.ctx.fillStyle = '#e1f0ff';
          this.ctx.beginPath();
          this.ctx.roundRect(optionX - optionSize/2, optionY - optionSize/2, optionSize, optionSize, 15);
          this.ctx.fill();

          this.ctx.fillStyle = '#1a5fb4';
          this.ctx.font = '40px Arial';
          this.ctx.fillText(emotion.emoji, optionX, optionY);

          if (this.difficulty < 4) {
            this.ctx.font = '16px Arial';
            this.ctx.fillText(emotion.name, optionX, optionY + 60);
          }
        }

        this.ctx.fillStyle = '#666';
        this.ctx.font = '24px Arial';
        this.ctx.fillText("Choose the matching face", centerX, height - 60);
      }

      drawSoundAttention(width, height, centerX, centerY) {
        this.ctx.fillStyle = '#1a5fb4';
        this.ctx.font = 'bold 32px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.textBaseline = 'middle';
        this.ctx.fillText("What do you hear?", centerX, 100);

        if (this.targetSound) {
          this.ctx.font = '80px Arial';
          this.ctx.fillText("üîä", centerX, centerY - 50);
          this.ctx.font = '24px Arial';
          this.ctx.fillText("Listen carefully...", centerX, centerY + 30);
        }

        const optionCount = this.soundOptions.length;
        const optionSize = 100;
        const spacing = 120;
        const startX = centerX - ((optionCount - 1) * spacing) / 2;

        for (let i = 0; i < optionCount; i++) {
          const optionX = startX + i * spacing;
          const optionY = height - 200;
          const sound = this.soundOptions[i];

          this.ctx.fillStyle = '#e1f0ff';
          this.ctx.beginPath();
          this.ctx.roundRect(optionX - optionSize/2, optionY - optionSize/2, optionSize, optionSize, 20);
          this.ctx.fill();

          this.ctx.fillStyle = '#1a5fb4';
          this.ctx.font = '60px Arial';
          this.ctx.fillText(sound.emoji, optionX, optionY);
        }

        this.ctx.fillStyle = '#666';
        this.ctx.font = '24px Arial';
        this.ctx.fillText("Tap the sound you heard", centerX, height - 60);
      }

      drawFollowPath(width, height, centerX, centerY) {
        this.ctx.fillStyle = '#1a5fb4';
        this.ctx.font = 'bold 32px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.textBaseline = 'middle';
        this.ctx.fillText("Follow The Path", centerX, 80);

        if (!this.pathDots.length) return;

        this.ctx.strokeStyle = '#4a9eff';
        this.ctx.lineWidth = 8;
        this.ctx.lineCap = 'round';
        this.ctx.beginPath();
        this.ctx.moveTo(this.pathDots[0].x, this.pathDots[0].y);

        for (let i = 1; i < this.pathDots.length; i++) {
          if (this.pathDots[i-1].completed) this.ctx.lineTo(this.pathDots[i].x, this.pathDots[i].y);
          else this.ctx.moveTo(this.pathDots[i].x, this.pathDots[i].y);
        }
        this.ctx.stroke();

        for (let i = 0; i < this.pathDots.length; i++) {
          const dot = this.pathDots[i];

          this.ctx.fillStyle = dot.completed ? '#4a9eff' : '#e1f0ff';
          this.ctx.beginPath();
          this.ctx.arc(dot.x, dot.y, dot.radius, 0, Math.PI * 2);
          this.ctx.fill();

          this.ctx.fillStyle = dot.completed ? 'white' : '#1a5fb4';
          this.ctx.font = 'bold 24px Arial';
          this.ctx.textAlign = 'center';
          this.ctx.textBaseline = 'middle';
          this.ctx.fillText(String(i + 1), dot.x, dot.y);

          if (i === this.currentDot && !dot.completed) {
            this.ctx.strokeStyle = '#4a9eff';
            this.ctx.lineWidth = 4;
            this.ctx.beginPath();
            this.ctx.arc(dot.x, dot.y, dot.radius + 5, 0, Math.PI * 2);
            this.ctx.stroke();
          }
        }

        if (this.currentDot > 0) {
          const prevDot = this.pathDots[this.currentDot - 1];
          const nextDot = this.currentDot < this.pathDots.length ? this.pathDots[this.currentDot] : prevDot;
          const walkerX = (prevDot.x + nextDot.x) / 2;
          const walkerY = (prevDot.y + nextDot.y) / 2;
          this.ctx.font = '40px Arial';
          this.ctx.fillText("üö∂üèæ", walkerX, walkerY - 60);
        }
      }

      drawTurnTaking(width, height, centerX, centerY) {
        this.ctx.fillStyle = '#1a5fb4';
        this.ctx.font = 'bold 32px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.textBaseline = 'middle';
        this.ctx.fillText("Turn-Taking Train", centerX, 80);

        this.ctx.strokeStyle = '#666';
        this.ctx.lineWidth = 4;
        this.ctx.beginPath();
        this.ctx.moveTo(80, centerY);
        this.ctx.lineTo(width - 80, centerY);
        this.ctx.stroke();

        const pieceWidth = (width - 200) / Math.max(1, this.trainPieces);

        for (let i = 0; i < this.trainPieces; i++) {
          const pieceX = 100 + i * pieceWidth;

          this.ctx.fillStyle = i < this.trainProgress ? '#4a9eff' : '#e1f0ff';
          this.ctx.beginPath();
          this.ctx.roundRect(pieceX, centerY - 30, pieceWidth - 10, 60, 10);
          this.ctx.fill();

          this.ctx.fillStyle = i < this.trainProgress ? 'white' : '#1a5fb4';
          this.ctx.font = 'bold 24px Arial';
          this.ctx.fillText(String(i + 1), pieceX + pieceWidth/2 - 15, centerY + 8);

          if (i === this.trainProgress && this.playerTurn) {
            this.ctx.strokeStyle = '#4a9eff';
            this.ctx.lineWidth = 4;
            this.ctx.beginPath();
            this.ctx.roundRect(pieceX - 5, centerY - 35, pieceWidth, 70, 12);
            this.ctx.stroke();
          }
        }

        this.ctx.fillStyle = this.playerTurn ? '#4a9eff' : '#666';
        this.ctx.font = '28px Arial';
        this.ctx.fillText(this.playerTurn ? "Your Turn!" : "Friend's Turn", centerX, height - 100);

        this.ctx.font = '60px Arial';
        this.ctx.fillText("üöÇ", 50, centerY);
      }

      drawRequestChoose(width, height, centerX, centerY) {
        this.ctx.fillStyle = '#1a5fb4';
        this.ctx.font = 'bold 32px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.textBaseline = 'middle';
        this.ctx.fillText("What do I want?", centerX, 100);

        this.ctx.font = '100px Arial';
        this.ctx.fillText("ü§î", centerX - 100, centerY);

        this.ctx.strokeStyle = '#4a9eff';
        this.ctx.lineWidth = 3;
        this.ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        this.ctx.beginPath();
        this.ctx.arc(centerX + 50, centerY - 30, 60, 0, Math.PI * 2);
        this.ctx.fill();
        this.ctx.stroke();

        if (this.requestTarget) {
          this.ctx.font = '50px Arial';
          this.ctx.fillStyle = '#1a5fb4';
          this.ctx.fillText(this.requestTarget, centerX + 50, centerY - 30);
        }

        const optionCount = this.requestOptions.length;
        const optionSize = 80;
        const spacing = 100;

        for (let i = 0; i < optionCount; i++) {
          const optionX = centerX + (i - (optionCount - 1) / 2) * spacing;
          const optionY = height - 200;
          const item = this.requestOptions[i];

          this.ctx.fillStyle = '#e1f0ff';
          this.ctx.beginPath();
          this.ctx.roundRect(optionX - optionSize/2, optionY - optionSize/2, optionSize, optionSize, 15);
          this.ctx.fill();

          this.ctx.fillStyle = '#1a5fb4';
          this.ctx.font = '40px Arial';
          this.ctx.fillText(item, optionX, optionY);
        }

        if (this.pleaseStep) {
          this.ctx.fillStyle = '#4a9eff';
          this.ctx.beginPath();
          this.ctx.roundRect(centerX - 60, height - 100, 120, 60, 15);
          this.ctx.fill();

          this.ctx.fillStyle = 'white';
          this.ctx.font = '28px Arial';
          this.ctx.fillText("Please", centerX, height - 70);
        }
      }

      startGameLoop() { requestAnimationFrame(this.gameLoop); }
    }

    // ============ INITIALIZATION ============
    window.addEventListener('DOMContentLoaded', () => {
      // roundRect polyfill
      if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
          if (w < 2 * r) r = w / 2;
          if (h < 2 * r) r = h / 2;
          this.beginPath();
          this.moveTo(x + r, y);
          this.arcTo(x + w, y, x + w, y + h, r);
          this.arcTo(x + w, y + h, x, y + h, r);
          this.arcTo(x, y + h, x, y, r);
          this.arcTo(x, y, x + w, y, r);
          this.closePath();
          return this;
        };
      }

      new JoyfulJourneysGame();
    });
  </script>
</body>
</html>
